<%include header%>
  <div id="wrap">
      <form name="form1" id="form1" method="post" action="/ticket/submitOrder">
     	<div class="container bs-wcy-tickediv">
        		<div class="bs-wcy-tickettop">
                		<div class="proBar01">
                        		<p class="info deepgreen">填写预订信息</p>
                                <p class="info">在线支付</p>
                                <p class="info">预定成功</p>
                        </div>
                </div>
          <div class="bs-wcy-tickeBox">
       		<div class="bs-wcy-tickeorderpad ticket">
                        		<h3><%=product.name%></h3>
                        		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="tab">
                                      <tr>
                                        <td width="35%" height="80" align="left" valign="middle">使用日期：<%=product.time%></td>
                                        <td width="43%" align="left" valign="middle">
                                          <input type="button"  id="sub" value="" class="subbt">
                                       	  <input type="text" class="num" id="num" name="num" value="1">
                                          <input type="button"  id="add" value="" class="addbt">
                                        </td>
                                        <td width="22%" align="left" valign="middle" class="bs-wcy_orange">
                                        	<span class="price" id="display"><%=product.price%></span>元
                                        </td>
                                  </tr>
                                      <tr class="bs-wcy_gray">
                                        <td align="left" valign="top">
                                        	<p><%-product.content.replace(/\n/g, '<br/>')%></p>
                                        </td>
                                        <td align="left" valign="top">
                                          	<p>预订须知</p>
                                          	<p>预订规则：</p>
                                            <p><%-product.bookRule.replace(/\n/g, '<br/>')%></p>
                                          	<p>使用规则：</p>
                                            <p><%-product.useRule.replace(/\n/g, '<br/>')%></p>
                                          	<p>取消规则：</p>
                                            <p><%-product.cancelRule.replace(/\n/g, '<br/>')%></p>
                                         </td>
                                        <td align="left" valign="middle">&nbsp;</td>
                                  </tr>
                          </table>
                <!-- hidden fields -->
                <input type="hidden" id="sp" value=<%=product.price%>/>
                <input type="hidden" id="pName" name="pName" value="<%=product.name%>"/>
                <input type="hidden" id="time" name="time" value="<%=product.time%>"/>
                <input type="hidden" id="orderType" name="orderType" value="t"/>
                <input type="hidden" id="pid" name="pid" value="<%=product.id%>"/>
                <input type="hidden" id="isWeekend" name="isWeekend" value="<%=product.isWeekend%>"/>
                <input type="hidden" id="lid" name="lid" value="<%=product.lid%>"/>
       		</div>
            <div class="bs-wcy-tickeorderpad ticket">
   		      <h3>旅客信息</h3>
                         <table width="100%" border="0" cellspacing="0" cellpadding="0" class="guesttab">
                            <tr>
                                <td width="13%" height="30" align="left" valign="middle">使用人姓名</td>
                                <td width="87%" align="left" valign="middle">
                                <input type="text" name="person" id="person"></td>
                            </tr>
                            <tr>
                                <td height="30" align="left" valign="middle">手机号</td>
                                <td align="left" valign="middle"><input type="text" name="mobile" id="mobile"></td>
                            </tr>
                            <tr id="errorBox" class="hidden">
                                <td colspan="2" id="errorMsg" style="color: #ff0000"></td>
                            </tr>
                        </table>
                    </div>
                <input type="submit" class="btn bs-ticketsubmit btn-lg" value="提交">
    	 </div>
       </form>
 </div>
<%include footer%>
    <script src="./../../js/underscore.min.js"></script>
    <script>
	$(document).ready(function(){
        var us = _.noConflict();
        var reCaculatePrice = function(num){
            if( num <= 0 ){
                num = 1;
            }else if( num > 99 ){
                num == 99;
            }
            $("#num").val(num);
            $('#display').html(parseInt($('#sp').val())*num);
        };
        reCaculatePrice(1);

        $("#add").click(function(){
            var num = $("#num").val();
            num = parseInt(num)+1;
            reCaculatePrice(num);
        });

        $("#sub").click(function(){
            var num = $("#num").val();
            num = parseInt(num)-1;
            reCaculatePrice(num);
        });

        $('#num').keyup(function(){
            var num = $('#num').val();
            reCaculatePrice(num);
        });

        //submit check
        $('#form1').submit(function(e){
            e.preventDefault();
            if($('#nav_logined').hasClass('hidden')){
                //如果是未登录状态则先跳登录框
                $('.loginModal').modal('show');
            }else if(us.isEmpty($('#person').val())){
                $('#errorBox').removeClass('hidden');
                $('#errorMsg').empty().text('使用人姓名不能为空!');
                return false;
            }else if(us.isEmpty($('#mobile').val())){
                $('#errorBox').removeClass('hidden');
                $('#errorMsg').empty().text('手机号不能为空!');
                return false;
            }else if(!/^1\d{10}$/gi.test($('#mobile').val())){
                $('#errorBox').removeClass('hidden');
                $('#errorMsg').empty().text('手机号码格式不正确!');
                return false;
            }
            $.ajax({
                 url:"/order/submit"
                ,method:"POST"
                ,data:$('#form1').serialize()
            }).done(function(data){
                        if(data.error == 10010){
                            $('.loginModal').modal('show');
                        }else if(data.error !=0 ){
                            //如果报错则显示错误信息
                            $('#errorBox').removeClass('hidden');
                            $('#errorMsg').empty().text(data.errorMsg);
                        }else{
                            window.location.href="/order/confirm/"+data._id;
                        }
                    }).fail(function(){
                        $('#errorBox').removeClass('hidden');
                        $('#errorMsg').empty().text("网络异常，请重试！");
                    });
        });
	});
	</script>